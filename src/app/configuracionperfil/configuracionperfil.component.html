@if (!cargando && usuario) {
  <div class="perfil-container">
    <!-- HEADER CON GRADIENTE DE FOCOSHOP -->
    <header class="perfil-header">
      <button class="btn-volver-header" (click)="volver()">
        <i class="fa fa-arrow-left"></i> Volver
      </button>
      
      <div class="logo">
        <i class="fa fa-heartbeat"></i>
        <span class="logo-text">MEDTOOLS</span>
      </div>
      
      <div class="header-spacer"></div>
    </header>

    <main class="perfil-content">
      <!-- TÍTULO DE SECCIÓN -->
      <div class="seccion-titulo">
        <h1>
          <i class="fa fa-cog"></i>
          Configuración de Cuenta
        </h1>
        <p>Administra tu información personal y preferencias</p>
      </div>

      <div class="perfil-grid">
        <!-- PERFIL -->
        <div class="perfil-card">
          <div class="card-header">
            <i class="fa fa-user-circle"></i>
            <h3>Información Personal</h3>
          </div>
          <div class="perfil-info">
            <img [src]="usuario.imagen || 'assets/img/avatar.png'" alt="avatar" class="avatar" />
            <div class="info-detalles">
              <p class="nombre">{{usuario.nombre}} {{usuario.apellido}}</p>
              <p class="dato-info">
                <i class="fa fa-envelope"></i>
                {{usuario.email}}
              </p>
              <p class="dato-info">
                <i class="fa fa-phone"></i>
                {{usuario.telefono || 'No especificado'}}
              </p>
            </div>
          </div>
          <button (click)="editarCuenta()" class="btn-accion">
            <i class="fa fa-edit"></i>
            Editar Cuenta
          </button>
        </div>

        <!-- DIRECCIÓN -->
        <div class="perfil-card">
          <div class="card-header">
            <i class="fa fa-map-marker-alt"></i>
            <h3>Dirección de Envío</h3>
          </div>
          <div class="perfil-info">
            <!-- Mostrar mientras carga -->
            @if (cargandoDirecciones) {
              <div class="loading-section">
                <i class="fa fa-spinner fa-spin"></i>
                <p>Cargando dirección...</p>
              </div>
            }
            
            <!-- Mostrar cuando no hay direcciones -->
            @else if (!tieneDireccion) {
              <div class="no-data-section">
                <i class="fa fa-map-marker-alt"></i>
                <p>No tienes dirección registrada</p>
                <span class="texto-ayuda">Agrega una dirección para realizar tus compras</span>
              </div>
            }
            
            <!-- Mostrar dirección principal -->
            @else {
              <div class="direccion-info">
                @if (direccionPrincipal) {
                  <div class="direccion-detalle">
                    <p class="direccion-linea principal">
                      <i class="fa fa-map-marker-alt"></i>
                      {{direccionPrincipal.calle}} #{{direccionPrincipal.numero_exterior}}
                      @if (direccionPrincipal.numero_interior) {
                        <span>, Int {{direccionPrincipal.numero_interior}}</span>
                      }
                    </p>
                    <p class="direccion-linea">{{direccionPrincipal.colonia}}</p>
                    <p class="direccion-linea">
                      CP {{direccionPrincipal.codigo_postal}}, 
                      {{direccionPrincipal.ciudad}}, 
                      {{direccionPrincipal.estado}}
                    </p>
                    <p class="direccion-linea">{{direccionPrincipal.pais}}</p>
                    
                    @if (direccionPrincipal.referencias) {
                      <p class="direccion-referencias">
                        <i class="fa fa-info-circle"></i>
                        {{direccionPrincipal.referencias}}
                      </p>
                    }
                  </div>
                } @else {
                  <p class="direccion-legacy">{{usuario.direccion}}</p>
                }
                
                <div class="contacto-info">
                  <p>
                    <i class="fa fa-phone"></i>
                    {{usuario.telefono || 'No disponible'}}
                  </p>
                  <p>
                    <i class="fa fa-envelope"></i>
                    {{usuario.email}}
                  </p>
                </div>
                
                <!-- Mostrar cantidad de direcciones si hay más de una -->
                @if (direcciones.length > 1) {
                  <button 
                    class="btn-direcciones-extra" 
                    (click)="abrirModalDirecciones()"
                    type="button">
                    <i class="fa fa-home"></i>
                    {{direcciones.length - 1}} dirección(es) adicional(es)
                    <i class="fa fa-chevron-right"></i>
                  </button>
                }
              </div>
            }
          </div>
          <button (click)="editarDireccion()" class="btn-accion">
            <i class="fa fa-{{tieneDireccion ? 'edit' : 'plus'}}"></i>
            {{tieneDireccion ? 'Editar Dirección' : 'Agregar Dirección'}}
          </button>
        </div>

        <!-- MÉTODO DE PAGO -->
        <div class="perfil-card">
          <div class="card-header">
            <i class="fa fa-credit-card"></i>
            <h3>Método de Pago</h3>
          </div>
          <div class="tarjeta-container">
            <div class="tarjeta" [style.background]="colorTarjeta">
              <div class="tarjeta-top">
                @if (bancoTarjeta) {
                  <span class="banco">{{bancoTarjeta}}</span>
                } @else {
                  <span class="tipo-mini">{{tipoTarjeta}}</span>
                }
                <i class="fa fa-credit-card chip-icon"></i>
              </div>
              <p class="numero">{{numeroTarjeta}}</p>
              <div class="tarjeta-bottom">
                <div class="titular-section">
                  <span class="label-small">TITULAR</span>
                  <span class="titular">{{titularTarjeta}}</span>
                </div>
                <span class="tipo">{{tipoTarjeta}}</span>
              </div>
            </div>
          </div>
          <button (click)="editarPago()" class="btn-accion">
            <i class="fa fa-edit"></i>
            Editar Método de Pago
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL DE DIRECCIONES -->
  @if (mostrarModal) {
    <div class="modal-overlay" (click)="cerrarModal()">
      <div class="modal-direcciones" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i class="fa fa-map-marker-alt"></i>
            Mis Direcciones
          </h2>
          <button class="btn-cerrar-modal" (click)="cerrarModal()">
            <i class="fa fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          @if (direcciones.length === 0) {
            <div class="no-direcciones">
              <i class="fa fa-map-marker-alt"></i>
              <p>No tienes direcciones guardadas</p>
              <button class="btn-agregar-direccion" (click)="editarDireccion()">
                <i class="fa fa-plus"></i> Agregar dirección
              </button>
            </div>
          } @else {
            <div class="lista-direcciones">
              @for (direccion of direcciones; track direccion.id_direccion) {
                <div 
                  class="direccion-item"
                  [class.seleccionada]="direccionPrincipal?.id_direccion === direccion.id_direccion"
                  (click)="seleccionarDireccionPrincipal(direccion)">
                  
                  <div class="direccion-contenido">
                    @if (direccionPrincipal?.id_direccion === direccion.id_direccion) {
                      <div class="badge-principal">
                        <i class="fa fa-check-circle"></i> Principal
                      </div>
                    }

                    <div class="direccion-texto">
                      <p class="direccion-titulo">
                        <i class="fa fa-map-marker-alt"></i>
                        <strong>{{direccion.calle}} #{{direccion.numero_exterior}}</strong>
                        @if (direccion.numero_interior) {
                          <span>, Int {{direccion.numero_interior}}</span>
                        }
                      </p>
                      <p class="direccion-detalles">{{direccion.colonia}}, CP {{direccion.codigo_postal}}</p>
                      <p class="direccion-detalles">{{direccion.ciudad}}, {{direccion.estado}}</p>
                      <p class="direccion-detalles">{{direccion.pais}}</p>
                      @if (direccion.referencias) {
                        <p class="direccion-referencias">
                          <i class="fa fa-info-circle"></i> {{direccion.referencias}}
                        </p>
                      }
                    </div>
                  </div>

                  <div class="direccion-acciones">
                    <button 
                      class="btn-icono btn-eliminar" 
                      (click)="eliminarDireccion(direccion, $event)"
                      [disabled]="eliminandoDireccion"
                      title="Eliminar dirección">
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                </div>
              }
            </div>

            <button class="btn-agregar-nueva" (click)="editarDireccion()">
              <i class="fa fa-plus-circle"></i> Agregar nueva dirección
            </button>
          }
        </div>
      </div>
    </div>
  }
} @else {
  <div class="loading">
    <div class="spinner"></div>
    <p>Cargando configuración...</p>
  </div>
}