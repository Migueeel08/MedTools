<div class="chat-ia-container">
  <!-- HEADER -->
  <header class="chat-header-main">
    <div class="header-left">
      <button class="btn-volver" (click)="volverAtras()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <div class="header-info">
        <i class="fas fa-robot"></i>
        <div>
          <h1>Asistente IA MedTools</h1>
          <p>Tu asesor médico inteligente</p>
        </div>
      </div>
    </div>

    <div class="header-right">
      <!-- SEARCH -->
      <div class="search-box">
        <input
          type="text"
          placeholder="Buscar productos..."
          [(ngModel)]="busqueda"
          (keyup.enter)="buscarProductos()"
        />
        <i class="fas fa-search"></i>
      </div>

      <!-- USER -->
      @if (isLoggedIn) {
        <div class="user-info" (click)="toggleUserMenu()">
          <img [src]="userImage" alt="Perfil" class="user-icon" />
          <div class="user-menu" [class.open]="userMenuOpen">
            <div class="user-name-header">
              <i class="fas fa-user-md"></i>
              {{ userName }}
            </div>
            <button (click)="irPerfil()">
              <i class="fas fa-user"></i> Mi perfil
            </button>
            <button (click)="irConfiguracion()">
              <i class="fas fa-cog"></i> Configuración
            </button>
            <div class="divider"></div>
            <button class="logout-btn" (click)="logout()">
              <i class="fas fa-sign-out-alt"></i> Cerrar sesión
            </button>
          </div>
        </div>
      }
    </div>
  </header>

  <!-- CHAT -->
  <div class="chat-content">
    <!-- MENSAJES -->
    <div class="chat-messages" #chatMessages>
      @for (msg of mensajes; track msg.id) {
        <div class="mensaje-wrapper" [class.usuario]="msg.es_usuario">
          <div class="mensaje" [class.usuario]="msg.es_usuario">
            <!-- MENSAJE DE TEXTO -->
            @if (msg.tipo === 'texto' || !msg.productos) {
              <p [innerHTML]="formatearTexto(msg.texto)"></p>
            }

            <!-- MENSAJE CON PRODUCTOS -->
            @if (msg.tipo === 'productos' && msg.productos && msg.productos.length > 0) {
              <p [innerHTML]="formatearTexto(msg.texto)"></p>
              
              <div class="productos-lista">
                @for (prod of msg.productos; track prod.id_producto) {
                  <div class="producto-item" (click)="irAProducto(prod.id_producto)">
                    <img [src]="prod.imagen" [alt]="prod.nombre" class="producto-img" />
                    <div class="producto-detalles">
                      <h4 class="producto-nombre">{{ prod.nombre }}</h4>
                      <p class="producto-marca">{{ prod.marca }}</p>
                      <p class="producto-precio">${{ prod.precio | number:'1.0-0' }}</p>
                      <div class="producto-rating">
                        @for (star of [1,2,3,4,5]; track star) {
                          <i class="fas fa-star" [class.filled]="star <= prod.calificacion"></i>
                        }
                        <span>({{ prod.reviews }})</span>
                      </div>
                      <button class="btn-ver-detalle">
                        <i class="fas fa-eye"></i> Ver detalles
                      </button>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          <span class="timestamp">
            {{ msg.timestamp | date:'HH:mm' }}
          </span>
        </div>
      }

      @if (cargando) {
        <div class="mensaje-wrapper">
          <div class="mensaje loading">
            <div class="typing">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- INPUT -->
    <div class="chat-input-area">
      <!-- SUGERENCIAS RÁPIDAS -->
      @if (mensajes.length <= 1) {
        <div class="sugerencias-rapidas">
          <p class="sugerencias-titulo">Sugerencias rápidas:</p>
          <div class="sugerencias-grid">
            @for (sugerencia of sugerenciasRapidas; track sugerencia) {
              <button class="btn-sugerencia" (click)="usarSugerencia(sugerencia)">
                <i class="fas fa-lightbulb"></i>
                {{ sugerencia }}
              </button>
            }
          </div>
        </div>
      }

      <div class="input-wrapper">
        <input
          type="text"
          placeholder="Pregunta algo sobre medicamentos, síntomas o equipos médicos..."
          [(ngModel)]="mensajeActual"
          (keyup.enter)="enviarMensaje()"
          [disabled]="cargando"
        />
        <button (click)="enviarMensaje()" [disabled]="cargando || !mensajeActual.trim()">
          @if (cargando) {
            <i class="fas fa-spinner fa-spin"></i>
          } @else {
            <i class="fas fa-paper-plane"></i>
          }
        </button>
      </div>
    </div>
  </div>
</div>